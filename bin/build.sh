#!/usr/bin/env bash

set -e

reporoot=$(git rev-parse --show-toplevel)

echo "invoking sqlc generate"
cd "${reporoot}"
go tool sqlc generate
echo "finished sqlc generate"

echo "invoking templ generate"
cd "${reporoot}"
go tool templ generate
echo "finished templ generate"

echo "invoking tsc"
cd "${reporoot}"
emitted=$(tsc --listEmittedFiles | grep "TSFILE:" | sed 's/^TSFILE: //g')
for f in ${emitted}; do
    sed -i '' '1s#^#// Code generated by tsc. DO NOT EDIT.\n\n#' "$f"
done
echo "finished tsc"

echo "fetching external deps"
cd "${reporoot}"
bin/fetch_client_deps.sh

echo "building ranger-ims-go"
cd "${reporoot}"
go build

echo "success...you can now run ./ranger-ims-go"
