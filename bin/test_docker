#!/usr/bin/env bash
#
# test_docker starts the IMS stack using docker compose, confirms that it's healthy,
# then stops and cleans up those docker resources. It returns a nonzero exit code if
# IMS did not become healthy.
#

set -o errexit -o nounset -o pipefail

# cd to the repo root, where docker-compose.yml lives
cd "$(git rev-parse --show-toplevel)"

exit_code=0
# `docker compose up` will only rebuild from the local Dockerfile if no image
# exists for the given name, e.g. ranger-ims-go. To change that behavior, you'd
# add a --build arg to the `docker compose up`.
echo "Starting Docker containers. Note this may not pick up any local changes"
docker compose up --wait-timeout 30 --wait || exit_code=$?

echo "Stopping and deleting those Docker containers"
docker compose rm -fsv

if [ "${exit_code}" -ne "0" ]; then
    echo "App failed health check"
    exit ${exit_code}
else
    echo "App started and passed health check"
fi
